#!/bin/bash

echo " -> Removing docker images"
docker rm -f db1 db1_slave

echo " -> Rebuilding the image from current directory"
docker build -t klevo/percona .

echo " -> Recreating data dir mount"
boot2docker ssh "sudo rm -rf /home/docker/percona-data; mkdir -p /home/docker/percona-data"

echo " -> Run the new master and slave containers"
docker run -d --name db1 \
  -v /home/docker/percona-data:/var/lib/mysql \
  -e MYSQL_ROOT_PASSWORD=mypass \
  --hostname db1 \
  klevo/percona

docker run -d --name db1_slave \
  --link db1:db1 \
  -e MYSQL_ROOT_PASSWORD=mypass \
  -e REPLICATION_SLAVE_MASTER_HOST=db1 \
  -e REPLICATION_SLAVE_REMOTE_PORT=3306 \
  -e REPLICATION_SLAVE_USER=db1_slave \
  -e REPLICATION_SLAVE_PASSWORD=slaveuserpass \
  --hostname db1_slave \
  klevo/percona

echo " -> Done."
docker ps

docker exec -i -t db1_slave bash